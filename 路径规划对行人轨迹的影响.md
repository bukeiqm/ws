# 路径规划如何影响行人轨迹

## 概述

在行人疏散模拟系统中，路径规划是决定行人运动轨迹的核心机制。本文档详细说明路径规划系统如何影响行人的实际运动轨迹。

## 一、路径规划系统架构

### 1.1 核心组件

系统包含三个主要的路径规划组件：

1. **PathPlanner（路径规划器）**
   - 负责基础路径查找和选择
   - 使用A*算法计算最优路径
   - 在路口进行动态路径选择

2. **MPCPlanner（AI路径推荐器）**
   - 基于模型预测控制（MPC）算法
   - 预测未来路径上的人流密度和危险程度
   - 为行人提供智能路径推荐

3. **AgentManager（行人管理器）**
   - 整合路径规划和物理运动
   - 将路径规划结果转化为实际运动

## 二、路径规划影响轨迹的机制

### 2.1 路径规划 → 目标点设置

**流程：**
```
路径规划 → 确定下一个目标区域 → 设置target_pos → 影响目标加速度
```

**代码实现位置：**
- `managers.py:941-1050` - `PathPlanner.update_path()`
- `managers.py:1108-1177` - `AgentManager.update_state()` 中的目标点更新

**关键代码片段：**
```python
# 从路径中获取下一个目标区域
next_area_id = agent.path[agent.path_index + 1]
next_area = self.map_manager.areas[next_area_id]
agent.target_pos = np.array(next_area.center)  # 设置目标点
```

**影响：**
- 目标点直接决定了行人的运动方向
- 目标点位置影响目标加速度的计算（`PhysicsEngine.calculate_goal_acceleration()`）

### 2.2 目标点 → 目标加速度

**流程：**
```
target_pos → 计算期望速度 → 计算目标加速度 → 影响总加速度
```

**代码实现位置：**
- `managers.py:114-129` - `PhysicsEngine.calculate_goal_acceleration()`

**计算公式：**
```python
vec_to_target = target - agent.pos
dist_to_target = np.linalg.norm(vec_to_target)
vel_desired = vec_to_target / dist_to_target * agent.desired_speed
acc_goal = ATTRACTION * (vel_desired - agent.vel) / agent.reaction_time
```

**影响：**
- 目标加速度是总加速度的重要组成部分
- 加速度大小取决于：
  - 到目标点的距离
  - 当前速度与期望速度的差异
  - 行人的反应时间（reaction_time）

### 2.3 总加速度 → 速度更新

**流程：**
```
总加速度 = 目标加速度 + 人际加速度 + 环境加速度 + 边界加速度 + 心理加速度
速度 += 总加速度 * dt
```

**代码实现位置：**
- `managers.py:1196-1197` - `AgentManager.update_state()`

**关键代码：**
```python
acc_total = acc_goal + acc_int + acc_obstacle + acc_danger + acc_fire + acc_bound + acc_psy
agent.vel += acc_total * constants.SIMULATION_DT
```

**影响：**
- 总加速度直接改变行人的速度向量
- 速度变化影响下一时刻的位置

### 2.4 速度 → 位置更新

**流程：**
```
速度 → 位置 += 速度 * dt → 形成轨迹
```

**代码实现位置：**
- `managers.py:1202` - `AgentManager.update_state()`

**关键代码：**
```python
agent.pos += agent.vel * constants.SIMULATION_DT
```

**影响：**
- 位置更新形成行人的实际运动轨迹
- 轨迹由一系列连续的位置点组成

## 三、路径选择策略对轨迹的影响

### 3.1 简单模式 vs 智能模式

#### 简单模式（`use_smart_choice = False`）
- **路径选择：** 选择距离出口最近的节点
- **轨迹特征：** 直线或近似直线，不考虑危险和拥挤
- **代码位置：** `managers.py:782-805`

#### 智能模式（`use_smart_choice = True`）
- **路径选择：** 综合考虑多个因素
- **轨迹特征：** 可能绕行避开危险和拥挤区域
- **代码位置：** `managers.py:816-939`

### 3.2 智能路径选择的评分系统

智能模式使用多因素评分系统，影响路径选择：

**评分因素：**

1. **距离得分**（权重：0.25）
   ```python
   distance_score = 1.0 / (1.0 + dist_to_exit)
   ```
   - 距离越近，得分越高
   - 影响：倾向于选择更短的路径

2. **危险程度得分**（权重：0.35）
   ```python
   danger_score = 1.0 / (1.0 + total_danger * DANGER_WEIGHT)
   ```
   - 危险越少，得分越高
   - 影响：避开危险源，轨迹可能绕行

3. **障碍物影响得分**（权重：0.15）
   ```python
   obstacle_score = 1.0 / (1.0 + total_obstacle * 0.5)
   ```
   - 障碍物越少，得分越高
   - 影响：避开障碍物密集区域

4. **从众行为得分**（权重：0.1）
   ```python
   herd_score = 1.0 + HERD_BEHAVIOR_FACTOR * choice_ratio
   ```
   - 邻居选择的路径得分更高
   - 影响：形成群体运动模式，轨迹可能聚集

5. **AI推荐得分**（权重：0.15，如果启用MPC）
   ```python
   if area_id == ai_recommendation:
       ai_score = 2.0  # AI推荐的路径得分更高
   ```
   - AI推荐的路径得分显著提高
   - 影响：遵循AI建议，可能形成更优的全局轨迹分布

**综合得分计算：**
```python
total_score = (distance_score * distance_weight + 
              danger_score * danger_weight + 
              obstacle_score * obstacle_weight + 
              herd_score * herd_weight +
              ai_score * ai_weight)
```

**权重动态调整：**
- 权重受恐慌值（panic）影响
- 恐慌值越高：
  - 危险权重增加（更关注安全）
  - 距离权重减少（可能绕行）
  - 从众权重减少（更独立决策）

### 3.3 恐慌状态对路径选择的影响

**代码位置：** `managers.py:760-779`

当恐慌值超过阈值时：
```python
if agent.panic > threshold:
    return np.random.choice(valid_choices)  # 随机选择
```

**影响：**
- 轨迹变得不可预测
- 可能偏离最优路径
- 形成混乱的运动模式

## 四、AI路径推荐（MPC）对轨迹的影响

### 4.1 MPC算法原理

**代码位置：** `managers.py:227-466`

MPC（模型预测控制）通过预测未来路径上的情况来推荐最优路径：

1. **预测路径密度**
   ```python
   def predict_path_density(path, all_agents, current_time, prediction_horizon)
   ```
   - 预测未来N步内路径上的人流密度
   - 影响：避开拥挤区域

2. **预测路径危险**
   ```python
   def predict_path_danger(path, dangers, fire_manager, prediction_horizon)
   ```
   - 预测未来N步内路径上的危险程度
   - 影响：提前避开危险区域

3. **计算路径代价**
   ```python
   cost = distance_cost + density_cost + danger_cost
   ```
   - 综合考虑距离、密度、危险
   - 选择代价最小的路径

### 4.2 MPC对轨迹的影响

**影响机制：**
1. **全局优化：** MPC考虑所有行人的未来位置，避免局部最优
2. **动态调整：** 根据实时情况更新推荐，轨迹可能动态变化
3. **拥堵预防：** 提前预测并避开即将拥堵的区域

**代码位置：** `managers.py:807-814`
```python
if constants.MPC_ENABLED and mpc_planner is not None:
    ai_recommendation = mpc_planner.recommend_path(
        agent, valid_choices, exit_pos, all_agents, 
        dangers, fire_manager, current_time
    )
```

## 五、路径更新机制

### 5.1 路径更新触发条件

**代码位置：** `managers.py:941-1050` - `PathPlanner.update_path()`

路径在以下情况会更新：

1. **路径为空或失效**
   ```python
   if len(agent.path) == 0 or current_area_id not in agent.path:
       agent.path = self.find_path(current_area_id, agent.exit_node_id)
   ```

2. **到达路径节点**
   - 当行人到达路径中的某个节点时，更新到下一个节点
   - 代码位置：`managers.py:1223-1247`

3. **智能选择触发**
   - 在路口（node）时，如果启用智能选择，会重新评估路径
   - 代码位置：`managers.py:1007-1031`

### 5.2 路径更新对轨迹的影响

**影响：**
- 轨迹可能突然改变方向（当路径更新时）
- 在路口处，轨迹可能出现分支选择
- 动态避障可能导致轨迹偏离原路径

## 六、实际轨迹形成过程

### 6.1 完整流程

```
1. 初始化
   ↓
2. 选择出口（PathPlanner.choose_exit）
   ↓
3. 规划初始路径（PathPlanner.find_path，使用A*算法）
   ↓
4. 设置目标点（路径中第一个节点的中心）
   ↓
5. 计算目标加速度（PhysicsEngine.calculate_goal_acceleration）
   ↓
6. 计算总加速度（包含所有力）
   ↓
7. 更新速度（vel += acc * dt）
   ↓
8. 更新位置（pos += vel * dt）
   ↓
9. 检查是否到达目标节点
   ↓
10. 如果到达，更新路径索引，设置新目标点
    ↓
11. 重复步骤5-10，直到到达出口
```

### 6.2 轨迹特征

**平滑性：**
- 加速度的连续变化使轨迹平滑
- 反应时间（reaction_time）影响轨迹的响应速度

**避障行为：**
- 环境加速度（障碍物、危险源）使轨迹绕行
- 边界力防止轨迹越界

**群体效应：**
- 从众行为使多个行人的轨迹聚集
- 人际力使轨迹保持安全距离

## 七、关键参数对轨迹的影响

### 7.1 路径规划相关参数

| 参数 | 位置 | 影响 |
|------|------|------|
| `HERD_BEHAVIOR_FACTOR` | `constants.py:54` | 从众行为强度，影响轨迹聚集程度 |
| `DANGER_WEIGHT` | `constants.py:76` | 危险权重，影响避障距离 |
| `MPC_HORIZON` | `constants.py:104` | MPC预测步数，影响前瞻性 |
| `MPC_AI_RECOMMENDATION_WEIGHT` | `constants.py:106` | AI推荐权重，影响对AI建议的遵循程度 |

### 7.2 物理运动相关参数

| 参数 | 位置 | 影响 |
|------|------|------|
| `ATTRACTION` | `constants.py:7` | 目标吸引力，影响轨迹的直线性 |
| `REACTION_TIME` | `constants.py:24-28` | 反应时间，影响轨迹的响应速度 |
| `DESIRED_SPEED` | `constants.py:12-16` | 期望速度，影响轨迹的速度特征 |
| `SIMULATION_DT` | `constants.py:6` | 时间步长，影响轨迹的平滑度 |

## 八、总结

路径规划通过以下机制影响行人轨迹：

1. **直接机制：** 路径规划确定目标点 → 目标点影响目标加速度 → 加速度改变速度 → 速度更新位置 → 形成轨迹

2. **间接机制：** 
   - 路径选择策略影响目标点的选择
   - 多因素评分系统使轨迹避开危险和拥挤
   - AI推荐优化全局轨迹分布

3. **动态调整：** 
   - 路径实时更新，轨迹动态变化
   - 恐慌状态改变路径选择逻辑
   - 环境变化触发路径重新规划

4. **群体效应：** 
   - 从众行为使轨迹聚集
   - 人际力保持安全距离
   - MPC优化全局分布

因此，路径规划是决定行人轨迹的核心机制，它不仅影响单个行人的运动路径，还通过群体交互和AI优化影响整个疏散系统的效率。

